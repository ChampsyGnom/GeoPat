/*################################################################################################*/
/* Script     : OA_Views.sql                                                                      */
/* Base       : Oracle                                                                            */
/* Auteur     : loic                                                                              */
/* Date       : 27/3/2014                                                                         */
/* Heure      : 15:16                                                                             */
/*################################################################################################*/

-- Vue V_TRAVAUX_OA
CREATE OR REPLACE FORCE VIEW "OA"."V_TRAVAUX_OA" ("DSC_OA__NUM_OA"
,"LIAISON"
,"SENS"
,"ABS_DEB"
,"ABS_FIN"
,"CD_FAM_OA__FAMILLE"
,"CD_TYPE_OA__TYPE"
,"CD_TRAVAUX_OA__CODE"
,"NATURE_TRAV_OA__NATURE"
,"DATE_RCP"
,"CD_ENTP_OA__ENTREPRISE"
,"DATE_FIN_GAR"
,"COUT"
,"MARCHE"
,"COMMENTAIRE"
,"ANNEE"
,"AGE"
) AS SELECT TRAVAUX_OA.DSC_OA__NUM_OA AS DSC_OA__NUM_OA
,DSC_OA.LIAISON AS LIAISON
,DSC_OA.SENS AS SENS
,DSC_OA.ABS_DEB AS ABS_DEB
,DSC_OA.ABS_FIN AS ABS_FIN
,DSC_OA.CD_FAM_OA__FAMILLE AS CD_FAM_OA__FAMILLE
,DSC_OA.CD_TYPE_OA__TYPE AS CD_TYPE_OA__TYPE
,TRAVAUX_OA.CD_TRAVAUX_OA__CODE AS CD_TRAVAUX_OA__CODE
,TRAVAUX_OA.NATURE_TRAV_OA__NATURE AS NATURE_TRAV_OA__NATURE
,TRAVAUX_OA.DATE_RCP AS DATE_RCP
,TRAVAUX_OA.CD_ENTP_OA__ENTREPRISE AS CD_ENTP_OA__ENTREPRISE
,TRAVAUX_OA.DATE_FIN_GAR AS DATE_FIN_GAR
,TRAVAUX_OA.COUT AS COUT
,TRAVAUX_OA.MARCHE AS MARCHE
,TRAVAUX_OA.COMMENTAIRE AS COMMENTAIRE
,TO_NUMBER(TO_CHAR(TRAVAUX_OA.DATE_RCP,'YYYY')) AS ANNEE
,(months_between(sysdate,TRAVAUX_OA.DATE_RCP)/12) AS AGE
 FROM TRAVAUX_OA,DSC_OA WHERE TRAVAUX_OA.DSC_OA__NUM_OA=DSC_OA.NUM_OA;
-- Vue V_DSC_OA
CREATE OR REPLACE FORCE VIEW "OA"."V_DSC_OA" ("NUM_OA"
,"LIAISON"
,"SENS"
,"ABS_DEB"
,"ABS_FIN"
,"NUM_EXPLOIT"
,"NOM_USAGE"
,"CD_FAM_OA__FAMILLE"
,"CD_TYPE_OA__TYPE"
,"CD_TABLIER_OA__TABLIER"
,"VPF"
,"DATE_MS"
,"NBPILESINTER"
,"GAB_MINI"
,"DEVIATION"
,"LONG_BIAISE"
,"CD_HIERARCHIE_OA__HIERARCHIE"
,"URGENCE"
,"CD_QUALITE_OA__QUALITE"
,"CD_IQOA_OA__NOTE_IQOA"
,"DERN_INSP"
,"PROSURV_ANNEE"
) AS SELECT DSC_OA.NUM_OA AS NUM_OA
,DSC_OA.LIAISON AS LIAISON
,DSC_OA.SENS AS SENS
,DSC_OA.ABS_DEB AS ABS_DEB
,DSC_OA.ABS_FIN AS ABS_FIN
,DSC_OA.NUM_EXPLOIT AS NUM_EXPLOIT
,DSC_OA.NOM_USAGE AS NOM_USAGE
,DSC_OA.CD_FAM_OA__FAMILLE AS CD_FAM_OA__FAMILLE
,DSC_OA.CD_TYPE_OA__TYPE AS CD_TYPE_OA__TYPE
,DSC_OA.CD_TABLIER_OA__TABLIER AS CD_TABLIER_OA__TABLIER
,DSC_OA.VPF AS VPF
,DSC_OA.DATE_MS AS DATE_MS
,DSC_OA.NBPILESINTER AS NBPILESINTER
,DSC_OA.GAB_MINI AS GAB_MINI
,DSC_OA.DEVIATION AS DEVIATION
,DSC_OA.LONG_BIAISE AS LONG_BIAISE
,DSC_OA.CD_HIERARCHIE_OA__HIERARCHIE AS CD_HIERARCHIE_OA__HIERARCHIE
,DSC_OA.URGENCE AS URGENCE
,DSC_OA.CD_QUALITE_OA__QUALITE AS CD_QUALITE_OA__QUALITE
,DSC_OA.CD_IQOA_OA__NOTE_IQOA AS CD_IQOA_OA__NOTE_IQOA
,DSC_OA.DERN_INSP AS DERN_INSP
,DSC_OA.PROSURV_ANNEE AS PROSURV_ANNEE
 FROM DSC_OA;
-- Vue V_HISTO_CAMP_OA
CREATE OR REPLACE FORCE VIEW "OA"."V_HISTO_CAMP_OA" ("ID_CAMP"
,"CD_TYPE_PV_OA__CODE"
,"CD_PRESTA_OA__PRESTATAIRE"
,"ANNEE"
,"DATEG"
,"DATER"
,"NB_OUVRAGE"
,"NB_OUVRAGE_VALID"
,"OBSERV"
) AS SELECT CAMP_OA.ID_CAMP AS ID_CAMP
,CAMP_OA.CD_TYPE_PV_OA__CODE AS CD_TYPE_PV_OA__CODE
,CAMP_OA.CD_PRESTA_OA__PRESTATAIRE AS CD_PRESTA_OA__PRESTATAIRE
,CAMP_OA.ANNEE AS ANNEE
,CAMP_OA.DATEG AS DATEG
,CAMP_OA.DATER AS DATER
,(select count(*) from dsc_camp_oa where camp_oa__id_camp = CAMP_OA.ID_CAMP ) as NB_OUVRAGE
,(select count(*) from dsc_camp_oa where camp_oa__id_camp = CAMP_OA.ID_CAMP and  dsc_camp_oa.realiser = -1) as NB_OUVRAGE_VALID
,CAMP_OA.OBSERV AS OBSERV
 FROM CAMP_OA;
-- Vue V_PREVISION_OA
CREATE OR REPLACE FORCE VIEW "OA"."V_PREVISION_OA" ("DSC_OA__NUM_OA"
,"LIAISON"
,"SENS"
,"ABS_DEB"
,"ABS_FIN"
,"CD_FAM_OA__FAMILLE"
,"CD_TYPE_OA__TYPE"
,"CD_TRAVAUX_OA__CODE"
,"TECHN"
,"DATE_DEBUT"
,"DATE_FIN"
,"CD_CONTRAINTE_OA__TYPE"
,"MONTANT"
,"COMMENTAIRE"
,"PREVISION_OA__ANNEE"
) AS SELECT PREVISION_OA.DSC_OA__NUM_OA AS DSC_OA__NUM_OA
,DSC_OA.LIAISON AS LIAISON
,DSC_OA.SENS AS SENS
,DSC_OA.ABS_DEB AS ABS_DEB
,DSC_OA.ABS_FIN AS ABS_FIN
,DSC_OA.CD_FAM_OA__FAMILLE AS CD_FAM_OA__FAMILLE
,DSC_OA.CD_TYPE_OA__TYPE AS CD_TYPE_OA__TYPE
,BPU_OA.CD_TRAVAUX_OA__CODE AS CD_TRAVAUX_OA__CODE
,BPU_OA.TECHN AS TECHN
,PREVISION_OA.DATE_DEBUT AS DATE_DEBUT
,PREVISION_OA.DATE_FIN AS DATE_FIN
,PREVISION_OA.CD_CONTRAINTE_OA__TYPE AS CD_CONTRAINTE_OA__TYPE
,PREVISION_OA.MONTANT AS MONTANT
,PREVISION_OA.COMMENTAIRE AS COMMENTAIRE
,TO_NUMBER(TO_CHAR(PREVISION_OA.DATE_DEBUT,'YYYY')) AS PREVISION_OA__ANNEE
 FROM PREVISION_OA,DSC_OA,BPU_OA WHERE PREVISION_OA.DSC_OA__NUM_OA=DSC_OA.NUM_OA AND PREVISION_OA.BPU_OA__ID_BPU=BPU_OA.ID_BPU;
-- Vue V_DERN_NOTE_OA
CREATE OR REPLACE FORCE VIEW "OA"."V_DERN_NOTE_OA" ("DSC_OA__NUM_OA"
,"LIAISON"
,"SENS"
,"ABS_DEB"
,"ABS_FIN"
,"CD_FAM_OA__FAMILLE"
,"CD_TYPE_OA__TYPE"
,"CAMP_OA__ID_CAMP"
,"CD_TYPE_PV_OA__CODE"
,"ANNEE"
,"CD_IQOA_OA__NOTE_IQOA"
,"DATE_VALID"
,"NOM_VALID"
,"PRIORITAIRE"
,"SECURITE"
,"NOTE1"
,"NOTE2"
,"NOTE3"
,"URGENCE"
,"QUALITE"
) AS SELECT INSP_OA.DSC_OA__NUM_OA AS DSC_OA__NUM_OA
,DSC_OA.LIAISON AS LIAISON
,DSC_OA.SENS AS SENS
,DSC_OA.ABS_DEB AS ABS_DEB
,DSC_OA.ABS_FIN AS ABS_FIN
,DSC_OA.CD_FAM_OA__FAMILLE AS CD_FAM_OA__FAMILLE
,DSC_OA.CD_TYPE_OA__TYPE AS CD_TYPE_OA__TYPE
,INSP_OA.CAMP_OA__ID_CAMP AS CAMP_OA__ID_CAMP
,CAMP_OA.CD_TYPE_PV_OA__CODE AS CD_TYPE_PV_OA__CODE
,CAMP_OA.ANNEE AS ANNEE
,INSP_OA.CD_IQOA_OA__NOTE_IQOA AS CD_IQOA_OA__NOTE_IQOA
,INSP_OA.DATE_VALID AS DATE_VALID
,INSP_OA.NOM_VALID AS NOM_VALID
,INSP_OA.PRIORITAIRE AS PRIORITAIRE
,INSP_OA.SECURITE AS SECURITE
,INSP_OA.NOTE1 AS NOTE1
,INSP_OA.NOTE2 AS NOTE2
,INSP_OA.NOTE3 AS NOTE3
,INSP_OA.URGENCE AS URGENCE
,INSP_OA.QUALITE AS QUALITE
 FROM INSP_OA,DSC_OA,CAMP_OA WHERE INSP_OA.DSC_OA__NUM_OA=DSC_OA.NUM_OA AND INSP_OA.CAMP_OA__ID_CAMP=CAMP_OA.ID_CAMP  and insp_oa.DATE_VALID is not null 
 and insp_oa.DATE_VALID= (select max(sub.DATE_VALID) from insp_oa sub where sub.dsc_oa__num_oa=dsc_oa.num_oa and sub.camp_oa__id_camp=insp_oa.camp_oa__id_camp);
-- Vue V_DETAIL_INSP_OA
CREATE OR REPLACE FORCE VIEW "OA"."V_DETAIL_INSP_OA" ("DSC_OA__NUM_OA"
,"LIAISON"
,"SENS"
,"ABS_DEB"
,"ABS_FIN"
,"CD_FAM_OA__FAMILLE"
,"CD_TYPE_OA__TYPE"
,"CAMP_OA__ID_CAMP"
,"CD_TYPE_PV_OA__CODE"
,"ANNEE"
,"ETAT"
,"DATE_VALID"
,"NOM_VALID"
) AS SELECT INSP_OA.DSC_OA__NUM_OA AS DSC_OA__NUM_OA
,DSC_OA.LIAISON AS LIAISON
,DSC_OA.SENS AS SENS
,DSC_OA.ABS_DEB AS ABS_DEB
,DSC_OA.ABS_FIN AS ABS_FIN
,DSC_OA.CD_FAM_OA__FAMILLE AS CD_FAM_OA__FAMILLE
,DSC_OA.CD_TYPE_OA__TYPE AS CD_TYPE_OA__TYPE
,INSP_OA.CAMP_OA__ID_CAMP AS CAMP_OA__ID_CAMP
,CAMP_OA.CD_TYPE_PV_OA__CODE AS CD_TYPE_PV_OA__CODE
,CAMP_OA.ANNEE AS ANNEE
,INSP_OA.ETAT AS ETAT
,INSP_OA.DATE_VALID AS DATE_VALID
,INSP_OA.NOM_VALID AS NOM_VALID
 FROM INSP_OA,DSC_OA,CAMP_OA WHERE INSP_OA.DSC_OA__NUM_OA=DSC_OA.NUM_OA AND INSP_OA.CAMP_OA__ID_CAMP=CAMP_OA.ID_CAMP;
-- Vue V_HISTO_NOTE_OA
CREATE OR REPLACE FORCE VIEW "OA"."V_HISTO_NOTE_OA" ("DSC_OA__NUM_OA"
,"LIAISON"
,"SENS"
,"ABS_DEB"
,"ABS_FIN"
,"CD_FAM_OA__FAMILLE"
,"CD_TYPE_OA__TYPE"
,"DATE_NOTE"
,"CD_ORIGIN_OA__ORIGINE"
,"NOTE_IQOA"
,"NOTE1"
,"NOTE2"
,"NOTE3"
,"URGENCE"
,"SECURITE"
,"PRIORITAIRE"
) AS SELECT HISTO_NOTE_OA.DSC_OA__NUM_OA AS DSC_OA__NUM_OA
,DSC_OA.LIAISON AS LIAISON
,DSC_OA.SENS AS SENS
,DSC_OA.ABS_DEB AS ABS_DEB
,DSC_OA.ABS_FIN AS ABS_FIN
,DSC_OA.CD_FAM_OA__FAMILLE AS CD_FAM_OA__FAMILLE
,DSC_OA.CD_TYPE_OA__TYPE AS CD_TYPE_OA__TYPE
,HISTO_NOTE_OA.DATE_NOTE AS DATE_NOTE
,HISTO_NOTE_OA.CD_ORIGIN_OA__ORIGINE AS CD_ORIGIN_OA__ORIGINE
,HISTO_NOTE_OA.NOTE_IQOA AS NOTE_IQOA
,HISTO_NOTE_OA.NOTE1 AS NOTE1
,HISTO_NOTE_OA.NOTE2 AS NOTE2
,HISTO_NOTE_OA.NOTE3 AS NOTE3
,HISTO_NOTE_OA.URGENCE AS URGENCE
,HISTO_NOTE_OA.SECURITE AS SECURITE
,HISTO_NOTE_OA.PRIORITAIRE AS PRIORITAIRE
 FROM HISTO_NOTE_OA,DSC_OA WHERE HISTO_NOTE_OA.DSC_OA__NUM_OA=DSC_OA.NUM_OA;
-- Vue V_ELT_INSP_OA
CREATE OR REPLACE FORCE VIEW "OA"."V_ELT_INSP_OA" (
"DSC_OA__NUM_OA"
,"CAMP_OA__ID_CAMP"
,"INDICE"
,"OBS"
,"LIBG"
,"LIBP"
,"LIBS"
,"LIBE"
,"ETAT"
,"NOM_VALID"
,"DATE_VALID"
) AS 
SELECT
ELT_INSP_OA.DSC_OA__NUM_OA AS DSC_OA__NUM_OA
,ELT_INSP_OA.CAMP_OA__ID_CAMP AS CAMP_OA__ID_CAMP
,ELT_INSP_OA.INDICE AS INDICE
,ELT_INSP_OA.OBS AS OBS
,GRP_OA.LIBG AS LIBG
,PRT_OA.LIBP AS LIBP
,SPRT_OA.LIBS AS LIBS
,ELT_OA.LIBE AS LIBE
,INSP_OA.ETAT AS ETAT
,INSP_OA.NOM_VALID AS NOM_VALID
,INSP_OA.DATE_VALID AS DATE_VALID
 FROM ELT_INSP_OA,INSP_OA,GRP_OA,PRT_OA,SPRT_OA,ELT_OA 
 WHERE ELT_INSP_OA.DSC_OA__NUM_OA=INSP_OA.DSC_OA__NUM_OA 
 AND ELT_INSP_OA.CAMP_OA__ID_CAMP=INSP_OA.CAMP_OA__ID_CAMP 
 AND ELT_INSP_OA.GRP_OA__ID_GRP=ELT_OA.GRP_OA__ID_GRP 
 AND ELT_INSP_OA.PRT_OA__ID_PRT=ELT_OA.PRT_OA__ID_PRT 
 AND ELT_INSP_OA.SPRT_OA__ID_SPRT=ELT_OA.SPRT_OA__ID_SPRT 
 AND ELT_INSP_OA.ELT_OA__ID_ELEM=ELT_OA.ID_ELEM  
 AND ELT_INSP_OA.GRP_OA__ID_GRP=SPRT_OA.GRP_OA__ID_GRP 
 AND ELT_INSP_OA.PRT_OA__ID_PRT=SPRT_OA.PRT_OA__ID_PRT 
 AND ELT_INSP_OA.SPRT_OA__ID_SPRT=SPRT_OA.ID_SPRT   
 AND ELT_INSP_OA.GRP_OA__ID_GRP=PRT_OA.GRP_OA__ID_GRP 
 AND ELT_INSP_OA.PRT_OA__ID_PRT=PRT_OA.ID_PRT 
 AND ELT_INSP_OA.GRP_OA__ID_GRP=GRP_OA.ID_GRP;
