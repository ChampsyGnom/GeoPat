/*################################################################################################*/
/* Script     : OH_Views.sql                                                                      */
/* Base       : Oracle                                                                            */
/* Auteur     : loic                                                                              */
/* Date       : 27/3/2014                                                                         */
/* Heure      : 15:16                                                                             */
/*################################################################################################*/

-- Vue V_TRAVAUX_OH
CREATE OR REPLACE FORCE VIEW "OH"."V_TRAVAUX_OH" ("DSC_OH__NUM_OH"
,"LIAISON"
,"SENS"
,"ABS_DEB"
,"CD_FAM_OH__FAMILLE"
,"CD_TYPE_OH__TYPE"
,"CD_TRAVAUX_OH__CODE"
,"NATURE_TRAV_OH__NATURE"
,"DATE_RCP"
,"CD_ENTP_OH__ENTREPRISE"
,"DATE_FIN_GAR"
,"COUT"
,"MARCHE"
,"COMMENTAIRE"
,"ANNEE"
,"AGE"
) AS SELECT TRAVAUX_OH.DSC_OH__NUM_OH AS DSC_OH__NUM_OH
,DSC_OH.LIAISON AS LIAISON
,DSC_OH.SENS AS SENS
,DSC_OH.ABS_DEB AS ABS_DEB
,DSC_OH.CD_FAM_OH__FAMILLE AS CD_FAM_OH__FAMILLE
,DSC_OH.CD_TYPE_OH__TYPE AS CD_TYPE_OH__TYPE
,TRAVAUX_OH.CD_TRAVAUX_OH__CODE AS CD_TRAVAUX_OH__CODE
,TRAVAUX_OH.NATURE_TRAV_OH__NATURE AS NATURE_TRAV_OH__NATURE
,TRAVAUX_OH.DATE_RCP AS DATE_RCP
,TRAVAUX_OH.CD_ENTP_OH__ENTREPRISE AS CD_ENTP_OH__ENTREPRISE
,TRAVAUX_OH.DATE_FIN_GAR AS DATE_FIN_GAR
,TRAVAUX_OH.COUT AS COUT
,TRAVAUX_OH.MARCHE AS MARCHE
,TRAVAUX_OH.COMMENTAIRE AS COMMENTAIRE
,TO_NUMBER(TO_CHAR(TRAVAUX_OH.DATE_RCP,'YYYY')) AS ANNEE
,(months_between(sysdate,TRAVAUX_OH.DATE_RCP)/12) AS AGE
 FROM TRAVAUX_OH,DSC_OH WHERE TRAVAUX_OH.DSC_OH__NUM_OH=DSC_OH.NUM_OH;
-- Vue V_DSC_OH
CREATE OR REPLACE FORCE VIEW "OH"."V_DSC_OH" ("LIAISON"
,"SENS"
,"ABS_DEB"
,"ABS_FIN"
,"NUM_OH"
,"CD_FAM_OH__FAMILLE"
,"CD_TYPE_OH__TYPE"
,"CD_SOUS_TYPE_OH__SOUS_TYPE"
,"CD_OUV_OH__OUV"
,"NUM_EXPLOIT"
,"CD_ECOUL_OH__ECOUL"
,"CD_EAU_OH__EAU"
,"PORTEE"
,"LONGUEUR"
,"OUV_AVAL"
,"DATE_MS"
,"PRIORITAIRE"
,"CD_QUALITE_OH__QUALITE"
,"DERN_INSP"
,"PROSURV_ANNEE"
) AS SELECT DSC_OH.LIAISON AS LIAISON
,DSC_OH.SENS AS SENS
,DSC_OH.ABS_DEB AS ABS_DEB
,DSC_OH.ABS_FIN AS ABS_FIN
,DSC_OH.NUM_OH AS NUM_OH
,DSC_OH.CD_FAM_OH__FAMILLE AS CD_FAM_OH__FAMILLE
,DSC_OH.CD_TYPE_OH__TYPE AS CD_TYPE_OH__TYPE
,DSC_OH.CD_SOUS_TYPE_OH__SOUS_TYPE AS CD_SOUS_TYPE_OH__SOUS_TYPE
,DSC_OH.CD_OUV_OH__OUV AS CD_OUV_OH__OUV
,DSC_OH.NUM_EXPLOIT AS NUM_EXPLOIT
,DSC_OH.CD_ECOUL_OH__ECOUL AS CD_ECOUL_OH__ECOUL
,DSC_OH.CD_EAU_OH__EAU AS CD_EAU_OH__EAU
,DSC_OH.PORTEE AS PORTEE
,DSC_OH.LONGUEUR AS LONGUEUR
,DSC_OH.OUV_AVAL AS OUV_AVAL
,DSC_OH.DATE_MS AS DATE_MS
,DSC_OH.PRIORITAIRE AS PRIORITAIRE
,DSC_OH.CD_QUALITE_OH__QUALITE AS CD_QUALITE_OH__QUALITE
,DSC_OH.DERN_INSP AS DERN_INSP
,DSC_OH.PROSURV_ANNEE AS PROSURV_ANNEE
 FROM DSC_OH;
-- Vue V_HISTO_CAMP_OH
CREATE OR REPLACE FORCE VIEW "OH"."V_HISTO_CAMP_OH" ("ID_CAMP"
,"CD_TYPE_PV_OH__CODE"
,"CD_PRESTA_OH__PRESTATAIRE"
,"ANNEE"
,"DATEG"
,"DATER"
,"NB_OUVRAGE"
,"NB_OUVRAGE_VALID"
,"OBSERV"
) AS SELECT CAMP_OH.ID_CAMP AS ID_CAMP
,CAMP_OH.CD_TYPE_PV_OH__CODE AS CD_TYPE_PV_OH__CODE
,CAMP_OH.CD_PRESTA_OH__PRESTATAIRE AS CD_PRESTA_OH__PRESTATAIRE
,CAMP_OH.ANNEE AS ANNEE
,CAMP_OH.DATEG AS DATEG
,CAMP_OH.DATER AS DATER
,(select count(*) from dsc_camp_OH where camp_OH__id_camp = CAMP_OH.ID_CAMP ) as NB_OUVRAGE
,(select count(*) from dsc_camp_OH where camp_OH__id_camp = CAMP_OH.ID_CAMP and  dsc_camp_OH.realiser = -1) as NB_OUVRAGE_VALID
,CAMP_OH.OBSERV AS OBSERV
 FROM CAMP_OH;
-- Vue V_PREVISION_OH
CREATE OR REPLACE FORCE VIEW "OH"."V_PREVISION_OH" ("DSC_OH__NUM_OH"
,"LIAISON"
,"SENS"
,"ABS_DEB"
,"ABS_FIN"
,"CD_FAM_OH__FAMILLE"
,"CD_TYPE_OH__TYPE"
,"CD_TRAVAUX_OH__CODE"
,"TECHN"
,"DATE_DEBUT"
,"DATE_FIN"
,"CD_CONTRAINTE_OH__TYPE"
,"MONTANT"
,"COMMENTAIRE"
,"PREVISION_OH__ANNEE"
) AS SELECT PREVISION_OH.DSC_OH__NUM_OH AS DSC_OH__NUM_OH
,DSC_OH.LIAISON AS LIAISON
,DSC_OH.SENS AS SENS
,DSC_OH.ABS_DEB AS ABS_DEB
,DSC_OH.ABS_FIN AS ABS_FIN
,DSC_OH.CD_FAM_OH__FAMILLE AS CD_FAM_OH__FAMILLE
,DSC_OH.CD_TYPE_OH__TYPE AS CD_TYPE_OH__TYPE
,BPU_OH.CD_TRAVAUX_OH__CODE AS CD_TRAVAUX_OH__CODE
,BPU_OH.TECHN AS TECHN
,PREVISION_OH.DATE_DEBUT AS DATE_DEBUT
,PREVISION_OH.DATE_FIN AS DATE_FIN
,PREVISION_OH.CD_CONTRAINTE_OH__TYPE AS CD_CONTRAINTE_OH__TYPE
,PREVISION_OH.MONTANT AS MONTANT
,PREVISION_OH.COMMENTAIRE AS COMMENTAIRE
,TO_NUMBER(TO_CHAR(PREVISION_OH.DATE_DEBUT,'YYYY')) AS PREVISION_OH__ANNEE
 FROM PREVISION_OH,DSC_OH,BPU_OH WHERE PREVISION_OH.DSC_OH__NUM_OH=DSC_OH.NUM_OH AND PREVISION_OH.BPU_OH__ID_BPU=BPU_OH.ID_BPU;
-- Vue V_DERN_NOTE_OH
CREATE OR REPLACE FORCE VIEW "OH"."V_DERN_NOTE_OH" ("DSC_OH__NUM_OH"
,"LIAISON"
,"SENS"
,"ABS_DEB"
,"ABS_FIN"
,"CD_FAM_OH__FAMILLE"
,"CD_TYPE_OH__TYPE"
,"CAMP_OH__ID_CAMP"
,"CD_TYPE_PV_OH__CODE"
,"ANNEE"
,"NOM_VALID"
,"DATE_VALID"
,"PRIORITAIRE"
,"SECURITE"
,"NOTE1"
,"NOTE2"
,"NOTE3"
,"NOTE4"
,"NOTE5"
,"URGENCE"
,"QUALITE"
) AS SELECT INSP_OH.DSC_OH__NUM_OH AS DSC_OH__NUM_OH
,DSC_OH.LIAISON AS LIAISON
,DSC_OH.SENS AS SENS
,DSC_OH.ABS_DEB AS ABS_DEB
,DSC_OH.ABS_FIN AS ABS_FIN
,DSC_OH.CD_FAM_OH__FAMILLE AS CD_FAM_OH__FAMILLE
,DSC_OH.CD_TYPE_OH__TYPE AS CD_TYPE_OH__TYPE
,INSP_OH.CAMP_OH__ID_CAMP AS CAMP_OH__ID_CAMP
,CAMP_OH.CD_TYPE_PV_OH__CODE AS CD_TYPE_PV_OH__CODE
,CAMP_OH.ANNEE AS ANNEE
,INSP_OH.NOM_VALID AS NOM_VALID
,INSP_OH.DATE_VALID AS DATE_VALID
,INSP_OH.PRIORITAIRE AS PRIORITAIRE
,INSP_OH.SECURITE AS SECURITE
,INSP_OH.NOTE1 AS NOTE1
,INSP_OH.NOTE2 AS NOTE2
,INSP_OH.NOTE3 AS NOTE3
,INSP_OH.NOTE4 AS NOTE4
,INSP_OH.NOTE5 AS NOTE5
,INSP_OH.URGENCE AS URGENCE
,INSP_OH.QUALITE AS QUALITE
 FROM INSP_OH,DSC_OH,CAMP_OH WHERE INSP_OH.DSC_OH__NUM_OH=DSC_OH.NUM_OH AND INSP_OH.CAMP_OH__ID_CAMP=CAMP_OH.ID_CAMP   and insp_oh.DATE_VALID is not null 
 and insp_oh.DATE_VALID= (select max(sub.DATE_VALID) from insp_oh sub where sub.dsc_oh__num_oh=dsc_oh.num_oh and sub.camp_oh__id_camp=insp_oh.camp_oh__id_camp);
-- Vue V_DETAIL_INSP_OH
CREATE OR REPLACE FORCE VIEW "OH"."V_DETAIL_INSP_OH" ("DSC_OH__NUM_OH"
,"LIAISON"
,"SENS"
,"ABS_DEB"
,"ABS_FIN"
,"CD_FAM_OH__FAMILLE"
,"CD_TYPE_OH__TYPE"
,"CAMP_OH__ID_CAMP"
,"CD_TYPE_PV_OH__CODE"
,"ANNEE"
,"ETAT"
,"NOM_VALID"
,"DATE_VALID"
) AS SELECT INSP_OH.DSC_OH__NUM_OH AS DSC_OH__NUM_OH
,DSC_OH.LIAISON AS LIAISON
,DSC_OH.SENS AS SENS
,DSC_OH.ABS_DEB AS ABS_DEB
,DSC_OH.ABS_FIN AS ABS_FIN
,DSC_OH.CD_FAM_OH__FAMILLE AS CD_FAM_OH__FAMILLE
,DSC_OH.CD_TYPE_OH__TYPE AS CD_TYPE_OH__TYPE
,INSP_OH.CAMP_OH__ID_CAMP AS CAMP_OH__ID_CAMP
,CAMP_OH.CD_TYPE_PV_OH__CODE AS CD_TYPE_PV_OH__CODE
,CAMP_OH.ANNEE AS ANNEE
,INSP_OH.ETAT AS ETAT
,INSP_OH.NOM_VALID AS NOM_VALID
,INSP_OH.DATE_VALID AS DATE_VALID
 FROM INSP_OH,DSC_OH,CAMP_OH WHERE INSP_OH.DSC_OH__NUM_OH=DSC_OH.NUM_OH AND INSP_OH.CAMP_OH__ID_CAMP=CAMP_OH.ID_CAMP;
-- Vue V_HISTO_NOTE_OH
CREATE OR REPLACE FORCE VIEW "OH"."V_HISTO_NOTE_OH" ("DSC_OH__NUM_OH"
,"LIAISON"
,"SENS"
,"ABS_DEB"
,"ABS_FIN"
,"CD_FAM_OH__FAMILLE"
,"CD_TYPE_OH__TYPE"
,"DATE_NOTE"
,"CD_ORIGIN_OH__ORIGINE"
,"NOTE1"
,"NOTE2"
,"NOTE3"
,"NOTE4"
,"NOTE5"
,"URGENCE"
,"SECURITE"
,"PRIORITAIRE"
) AS SELECT HISTO_NOTE_OH.DSC_OH__NUM_OH AS DSC_OH__NUM_OH
,DSC_OH.LIAISON AS LIAISON
,DSC_OH.SENS AS SENS
,DSC_OH.ABS_DEB AS ABS_DEB
,DSC_OH.ABS_FIN AS ABS_FIN
,DSC_OH.CD_FAM_OH__FAMILLE AS CD_FAM_OH__FAMILLE
,DSC_OH.CD_TYPE_OH__TYPE AS CD_TYPE_OH__TYPE
,HISTO_NOTE_OH.DATE_NOTE AS DATE_NOTE
,HISTO_NOTE_OH.CD_ORIGIN_OH__ORIGINE AS CD_ORIGIN_OH__ORIGINE
,HISTO_NOTE_OH.NOTE1 AS NOTE1
,HISTO_NOTE_OH.NOTE2 AS NOTE2
,HISTO_NOTE_OH.NOTE3 AS NOTE3
,HISTO_NOTE_OH.NOTE4 AS NOTE4
,HISTO_NOTE_OH.NOTE5 AS NOTE5
,HISTO_NOTE_OH.URGENCE AS URGENCE
,HISTO_NOTE_OH.SECURITE AS SECURITE
,HISTO_NOTE_OH.PRIORITAIRE AS PRIORITAIRE
 FROM HISTO_NOTE_OH,DSC_OH WHERE HISTO_NOTE_OH.DSC_OH__NUM_OH=DSC_OH.NUM_OH;
-- Vue V_ELT_INSP_OH
CREATE OR REPLACE FORCE VIEW "OH"."V_ELT_INSP_OH" (
"DSC_OH__NUM_OH"
,"CAMP_OH__ID_CAMP"
,"INDICE"
,"OBS"
,"LIBG"
,"LIBP"
,"LIBS"
,"LIBE"
,"ETAT"
,"NOM_VALID"
,"DATE_VALID"
) AS 
SELECT
ELT_INSP_OH.DSC_OH__NUM_OH AS DSC_OH__NUM_OH
,ELT_INSP_OH.CAMP_OH__ID_CAMP AS CAMP_OH__ID_CAMP
,ELT_INSP_OH.INDICE AS INDICE
,ELT_INSP_OH.OBS AS OBS
,GRP_OH.LIBG AS LIBG
,PRT_OH.LIBP AS LIBP
,SPRT_OH.LIBS AS LIBS
,ELT_OH.LIBE AS LIBE
,INSP_OH.ETAT AS ETAT
,INSP_OH.NOM_VALID AS NOM_VALID
,INSP_OH.DATE_VALID AS DATE_VALID
 FROM ELT_INSP_OH,INSP_OH,GRP_OH,PRT_OH,SPRT_OH,ELT_OH 
 WHERE ELT_INSP_OH.DSC_OH__NUM_OH=INSP_OH.DSC_OH__NUM_OH 
 AND ELT_INSP_OH.CAMP_OH__ID_CAMP=INSP_OH.CAMP_OH__ID_CAMP 
 AND ELT_INSP_OH.GRP_OH__ID_GRP=ELT_OH.GRP_OH__ID_GRP 
 AND ELT_INSP_OH.PRT_OH__ID_PRT=ELT_OH.PRT_OH__ID_PRT 
 AND ELT_INSP_OH.SPRT_OH__ID_SPRT=ELT_OH.SPRT_OH__ID_SPRT 
 AND ELT_INSP_OH.ELT_OH__ID_ELEM=ELT_OH.ID_ELEM  
 AND ELT_INSP_OH.GRP_OH__ID_GRP=SPRT_OH.GRP_OH__ID_GRP 
 AND ELT_INSP_OH.PRT_OH__ID_PRT=SPRT_OH.PRT_OH__ID_PRT 
 AND ELT_INSP_OH.SPRT_OH__ID_SPRT=SPRT_OH.ID_SPRT   
 AND ELT_INSP_OH.GRP_OH__ID_GRP=PRT_OH.GRP_OH__ID_GRP 
 AND ELT_INSP_OH.PRT_OH__ID_PRT=PRT_OH.ID_PRT 
 AND ELT_INSP_OH.GRP_OH__ID_GRP=GRP_OH.ID_GRP;
