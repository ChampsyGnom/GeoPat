/*################################################################################################*/
/* Script     : BSN_Views.sql                                                                     */
/* Base       : Oracle                                                                            */
/* Auteur     : loic                                                                              */
/* Date       : 27/3/2014                                                                         */
/* Heure      : 15:16                                                                             */
/*################################################################################################*/

-- Vue V_TRAVAUX_BSN
CREATE OR REPLACE FORCE VIEW "BSN"."V_TRAVAUX_BSN" ("DSC_BSN__NUM_BSN"
,"LIAISON"
,"SENS"
,"ABS_DEB"
,"CD_FAM_BSN__FAMILLE"
,"CD_TYPE_BSN__TYPE"
,"CD_TRAVAUX_BSN__CODE"
,"NATURE_TRAV_BSN__NATURE"
,"DATE_RCP"
,"CD_ENTP_BSN__ENTREPRISE"
,"DATE_FIN_GAR"
,"COUT"
,"MARCHE"
,"COMMENTAIRE"
,"ANNEE"
,"AGE"
) AS SELECT TRAVAUX_BSN.DSC_BSN__NUM_BSN AS DSC_BSN__NUM_BSN
,DSC_BSN.LIAISON AS LIAISON
,DSC_BSN.SENS AS SENS
,DSC_BSN.ABS_DEB AS ABS_DEB
,DSC_BSN.CD_FAM_BSN__FAMILLE AS CD_FAM_BSN__FAMILLE
,DSC_BSN.CD_TYPE_BSN__TYPE AS CD_TYPE_BSN__TYPE
,TRAVAUX_BSN.CD_TRAVAUX_BSN__CODE AS CD_TRAVAUX_BSN__CODE
,TRAVAUX_BSN.NATURE_TRAV_BSN__NATURE AS NATURE_TRAV_BSN__NATURE
,TRAVAUX_BSN.DATE_RCP AS DATE_RCP
,TRAVAUX_BSN.CD_ENTP_BSN__ENTREPRISE AS CD_ENTP_BSN__ENTREPRISE
,TRAVAUX_BSN.DATE_FIN_GAR AS DATE_FIN_GAR
,TRAVAUX_BSN.COUT AS COUT
,TRAVAUX_BSN.MARCHE AS MARCHE
,TRAVAUX_BSN.COMMENTAIRE AS COMMENTAIRE
,TO_NUMBER(TO_CHAR(TRAVAUX_BSN.DATE_RCP,'YYYY')) AS ANNEE
,(months_between(sysdate,TRAVAUX_BSN.DATE_RCP)/12) AS AGE
 FROM TRAVAUX_BSN,DSC_BSN WHERE TRAVAUX_BSN.DSC_BSN__NUM_BSN=DSC_BSN.NUM_BSN;
-- Vue V_EQUIPEMENT_BSN
CREATE OR REPLACE FORCE VIEW "BSN"."V_EQUIPEMENT_BSN" ("LIAISON"
,"SENS"
,"ABS_DEB"
,"DSC_BSN__NUM_BSN"
,"CD_TYPE_BSN__TYPE"
,"CD_FAM_BSN__FAMILLE"
,"CD_FAMEQP_BSN__FAM"
,"CD_TYPEQP_BSN__TYPE"
,"POSITION"
,"DATE_MS"
) AS SELECT DSC_BSN.LIAISON AS LIAISON
,DSC_BSN.SENS AS SENS
,DSC_BSN.ABS_DEB AS ABS_DEB
,EQUIPEMENT_BSN.DSC_BSN__NUM_BSN AS DSC_BSN__NUM_BSN
,DSC_BSN.CD_TYPE_BSN__TYPE AS CD_TYPE_BSN__TYPE
,DSC_BSN.CD_FAM_BSN__FAMILLE AS CD_FAM_BSN__FAMILLE
,EQUIPEMENT_BSN.CD_FAMEQP_BSN__FAM AS CD_FAMEQP_BSN__FAM
,EQUIPEMENT_BSN.CD_TYPEQP_BSN__TYPE AS CD_TYPEQP_BSN__TYPE
,EQUIPEMENT_BSN.POSITION AS POSITION
,EQUIPEMENT_BSN.DATE_MS AS DATE_MS
 FROM DSC_BSN,EQUIPEMENT_BSN WHERE EQUIPEMENT_BSN.DSC_BSN__NUM_BSN=DSC_BSN.NUM_BSN;
-- Vue V_DSC_BSN
 CREATE OR REPLACE FORCE VIEW "BSN"."V_DSC_BSN" ("NUM_BSN", "NUM_EXPLOIT", "LIAISON", "SENS", "ABS_DEB", "DATE_MS", "CD_FAM_BSN__FAMILLE", "CD_TYPE_BSN__TYPE", "VOLUME", "SURF_VERSANT", "PIETON", "VEHICULE", "CD_ACCES_BSN__VACCES", "URGENCE", "CD_QUALITE_BSN__QUALITE", "DERN_INSP", "PROSURV_ANNEE") AS 
  SELECT DSC_BSN.NUM_BSN AS NUM_BSN
,DSC_BSN.NUM_EXPLOIT AS NUM_EXPLOIT
,DSC_BSN.LIAISON AS LIAISON
,DSC_BSN.SENS AS SENS
,DSC_BSN.ABS_DEB AS ABS_DEB
,DSC_BSN.DATE_MS AS DATE_MS
,DSC_BSN.CD_FAM_BSN__FAMILLE AS CD_FAM_BSN__FAMILLE
,DSC_BSN.CD_TYPE_BSN__TYPE AS CD_TYPE_BSN__TYPE
,DSC_BSN.VOL_UTIL AS VOLUME
,DSC_BSN.SURF_VERSANT AS SURF_VERSANT
,DSC_BSN.PIETON AS PIETON
,DSC_BSN.VEHICULE AS VEHICULE
,DSC_BSN.CD_ACCES_BSN__VACCES AS CD_ACCES_BSN__VACCES
,DSC_BSN.URGENCE AS URGENCE
,DSC_BSN.CD_QUALITE_BSN__QUALITE AS CD_QUALITE_BSN__QUALITE
,DSC_BSN.DERN_INSP AS DERN_INSP
,DSC_BSN.PROSURV_ANNEE AS PROSURV_ANNEE
 FROM DSC_BSN;
 
-- Vue V_HISTO_CAMP_BSN
  CREATE OR REPLACE FORCE VIEW "BSN"."V_HISTO_CAMP_BSN" ("ID_CAMP"
, "CD_TYPE_PV_BSN__CODE"
, "CD_PRESTA_BSN__PRESTATAIRE"
, "ANNEE"
, "DATER"
, "DATEG"
, "NB_OUVRAGE"
, "NB_OUVRAGE_VALID"
, "OBSERV") AS   SELECT 
CAMP_BSN.ID_CAMP AS ID_CAMP
,CAMP_BSN.CD_TYPE_PV_BSN__CODE AS CD_TYPE_PV_BSN__CODE
,CAMP_BSN.CD_PRESTA_BSN__PRESTATAIRE AS CD_PRESTA_BSN__PRESTATAIRE
,CAMP_BSN.ANNEE AS ANNEE
,CAMP_BSN.DATER AS DATER
,CAMP_BSN.DATEG AS DATEG
,(select count(*) from dsc_camp_BSN where camp_BSN__id_camp = CAMP_BSN.ID_CAMP ) as NB_OUVRAGE
,(select count(*) from dsc_camp_BSN where camp_BSN__id_camp = CAMP_BSN.ID_CAMP and  dsc_camp_BSN.realiser = -1) as NB_OUVRAGE_VALID
,CAMP_BSN.OBSERV AS OBSERV
 FROM CAMP_BSN;
 

-- Vue V_IMPLUVIUM_BSN
CREATE OR REPLACE FORCE VIEW "BSN"."V_IMPLUVIUM_BSN" ("DSC_BSN__NUM_BSN"
,"LIAISON"
,"SENS"
,"ABS_DEB"
,"ABS_FIN"
,"CD_FAM_BSN__FAMILLE"
,"CD_TYPE_BSN__TYPE"
,"SURFACE"
,"COMMENTAIRE"
) AS SELECT IMPLUVIUM_BSN.DSC_BSN__NUM_BSN AS DSC_BSN__NUM_BSN
,IMPLUVIUM_BSN.LIAISON AS LIAISON
,IMPLUVIUM_BSN.SENS AS SENS
,IMPLUVIUM_BSN.ABS_DEB AS ABS_DEB
,IMPLUVIUM_BSN.ABS_FIN AS ABS_FIN
,DSC_BSN.CD_FAM_BSN__FAMILLE AS CD_FAM_BSN__FAMILLE
,DSC_BSN.CD_TYPE_BSN__TYPE AS CD_TYPE_BSN__TYPE
,IMPLUVIUM_BSN.SURFACE AS SURFACE
,IMPLUVIUM_BSN.COMMENTAIRE AS COMMENTAIRE
 FROM IMPLUVIUM_BSN,DSC_BSN WHERE IMPLUVIUM_BSN.DSC_BSN__NUM_BSN=DSC_BSN.NUM_BSN;
-- Vue V_PREVISION_BSN
CREATE OR REPLACE FORCE VIEW "BSN"."V_PREVISION_BSN" ("DSC_BSN__NUM_BSN"
,"LIAISON"
,"SENS"
,"ABS_DEB"
,"CD_FAM_BSN__FAMILLE"
,"CD_TYPE_BSN__TYPE"
,"CD_TRAVAUX_BSN__CODE"
,"TECHN"
,"DATE_DEBUT"
,"DATE_FIN"
,"CD_CONTRAINTE_BSN__TYPE"
,"MONTANT"
,"COMMENTAIRE"
,"PREVISION_BSN__ANNEE"
) AS SELECT PREVISION_BSN.DSC_BSN__NUM_BSN AS DSC_BSN__NUM_BSN
,DSC_BSN.LIAISON AS LIAISON
,DSC_BSN.SENS AS SENS
,DSC_BSN.ABS_DEB AS ABS_DEB
,DSC_BSN.CD_FAM_BSN__FAMILLE AS CD_FAM_BSN__FAMILLE
,DSC_BSN.CD_TYPE_BSN__TYPE AS CD_TYPE_BSN__TYPE
,BPU_BSN.CD_TRAVAUX_BSN__CODE AS CD_TRAVAUX_BSN__CODE
,BPU_BSN.TECHN AS TECHN
,PREVISION_BSN.DATE_DEBUT AS DATE_DEBUT
,PREVISION_BSN.DATE_FIN AS DATE_FIN
,PREVISION_BSN.CD_CONTRAINTE_BSN__TYPE AS CD_CONTRAINTE_BSN__TYPE
,PREVISION_BSN.MONTANT AS MONTANT
,PREVISION_BSN.COMMENTAIRE AS COMMENTAIRE
,TO_NUMBER(TO_CHAR(PREVISION_BSN.DATE_DEBUT,'YYYY')) AS PREVISION_BSN__ANNEE
 FROM PREVISION_BSN,DSC_BSN,BPU_BSN WHERE PREVISION_BSN.DSC_BSN__NUM_BSN=DSC_BSN.NUM_BSN AND PREVISION_BSN.BPU_BSN__ID_BPU=BPU_BSN.ID_BPU;
-- Vue V_GEOMETRIE_BSN
CREATE OR REPLACE FORCE VIEW "BSN"."V_GEOMETRIE_BSN" ("DSC_BSN__NUM_BSN"
,"LIAISON"
,"SENS"
,"ABS_DEB"
,"CD_FAM_BSN__FAMILLE"
,"CD_TYPE_BSN__TYPE"
,"SURF"
,"PROF"
,"PENTE"
,"PERIMETRE"
) AS SELECT GEOMETRIE_BSN.DSC_BSN__NUM_BSN AS DSC_BSN__NUM_BSN
,DSC_BSN.LIAISON AS LIAISON
,DSC_BSN.SENS AS SENS
,DSC_BSN.ABS_DEB AS ABS_DEB
,DSC_BSN.CD_FAM_BSN__FAMILLE AS CD_FAM_BSN__FAMILLE
,DSC_BSN.CD_TYPE_BSN__TYPE AS CD_TYPE_BSN__TYPE
,GEOMETRIE_BSN.SURF AS SURF
,GEOMETRIE_BSN.PROF AS PROF
,GEOMETRIE_BSN.PENTE AS PENTE
,GEOMETRIE_BSN.PERIMETRE AS PERIMETRE
 FROM GEOMETRIE_BSN,DSC_BSN WHERE GEOMETRIE_BSN.DSC_BSN__NUM_BSN=DSC_BSN.NUM_BSN;
-- Vue V_DERN_NOTE_BSN
CREATE OR REPLACE FORCE VIEW "BSN"."V_DERN_NOTE_BSN" ("DSC_BSN__NUM_BSN"
,"LIAISON"
,"SENS"
,"ABS_DEB"
,"CD_FAM_BSN__FAMILLE"
,"CD_TYPE_BSN__TYPE"
,"CAMP_BSN__ID_CAMP"
,"CD_TYPE_PV_BSN__CODE"
,"ANNEE"
,"DATE_VALID"
,"NOM_VALID"
,"SECURITE"
,"PRIORITAIRE"
,"NOTE1"
,"NOTE2"
,"NOTE3"
,"NOTE4"
,"URGENCE"
,"QUALITE"
) AS SELECT INSP_BSN.DSC_BSN__NUM_BSN AS DSC_BSN__NUM_BSN
,DSC_BSN.LIAISON AS LIAISON
,DSC_BSN.SENS AS SENS
,DSC_BSN.ABS_DEB AS ABS_DEB
,DSC_BSN.CD_FAM_BSN__FAMILLE AS CD_FAM_BSN__FAMILLE
,DSC_BSN.CD_TYPE_BSN__TYPE AS CD_TYPE_BSN__TYPE
,INSP_BSN.CAMP_BSN__ID_CAMP AS CAMP_BSN__ID_CAMP
,CAMP_BSN.CD_TYPE_PV_BSN__CODE AS CD_TYPE_PV_BSN__CODE
,CAMP_BSN.ANNEE AS ANNEE
,INSP_BSN.DATE_VALID AS DATE_VALID
,INSP_BSN.NOM_VALID AS NOM_VALID
,INSP_BSN.SECURITE AS SECURITE
,INSP_BSN.PRIORITAIRE AS PRIORITAIRE
,INSP_BSN.NOTE1 AS NOTE1
,INSP_BSN.NOTE2 AS NOTE2
,INSP_BSN.NOTE3 AS NOTE3
,INSP_BSN.NOTE4 AS NOTE4
,INSP_BSN.URGENCE AS URGENCE
,INSP_BSN.QUALITE AS QUALITE
 FROM INSP_BSN,DSC_BSN,CAMP_BSN WHERE INSP_BSN.DSC_BSN__NUM_BSN=DSC_BSN.NUM_BSN AND INSP_BSN.CAMP_BSN__ID_CAMP=CAMP_BSN.ID_CAMP  and insp_bsn.DATE_VALID is not null 
 and insp_bsn.DATE_VALID= (select max(sub.DATE_VALID) from insp_bsn sub where sub.dsc_bsn__num_bsn=dsc_bsn.num_bsn and sub.camp_bsn__id_camp=insp_bsn.camp_bsn__id_camp);
-- Vue V_DETAIL_INSP_BSN
CREATE OR REPLACE FORCE VIEW "BSN"."V_DETAIL_INSP_BSN" ("DSC_BSN__NUM_BSN"
,"LIAISON"
,"SENS"
,"ABS_DEB"
,"CD_FAM_BSN__FAMILLE"
,"CD_TYPE_BSN__TYPE"
,"CAMP_BSN__ID_CAMP"
,"CD_TYPE_PV_BSN__CODE"
,"ANNEE"
,"ETAT"
,"DATE_VALID"
,"NOM_VALID"
) AS SELECT INSP_BSN.DSC_BSN__NUM_BSN AS DSC_BSN__NUM_BSN
,DSC_BSN.LIAISON AS LIAISON
,DSC_BSN.SENS AS SENS
,DSC_BSN.ABS_DEB AS ABS_DEB
,DSC_BSN.CD_FAM_BSN__FAMILLE AS CD_FAM_BSN__FAMILLE
,DSC_BSN.CD_TYPE_BSN__TYPE AS CD_TYPE_BSN__TYPE
,INSP_BSN.CAMP_BSN__ID_CAMP AS CAMP_BSN__ID_CAMP
,CAMP_BSN.CD_TYPE_PV_BSN__CODE AS CD_TYPE_PV_BSN__CODE
,CAMP_BSN.ANNEE AS ANNEE
,INSP_BSN.ETAT AS ETAT
,INSP_BSN.DATE_VALID AS DATE_VALID
,INSP_BSN.NOM_VALID AS NOM_VALID
 FROM INSP_BSN,DSC_BSN,CAMP_BSN WHERE INSP_BSN.DSC_BSN__NUM_BSN=DSC_BSN.NUM_BSN AND INSP_BSN.CAMP_BSN__ID_CAMP=CAMP_BSN.ID_CAMP;
-- Vue V_HISTO_NOTE_BSN
CREATE OR REPLACE FORCE VIEW "BSN"."V_HISTO_NOTE_BSN" ("DSC_BSN__NUM_BSN"
,"LIAISON"
,"SENS"
,"ABS_DEB"
,"CD_FAM_BSN__FAMILLE"
,"CD_TYPE_BSN__TYPE"
,"DATE_NOTE"
,"CD_ORIGIN_BSN__ORIGINE"
,"NOTE1"
,"NOTE2"
,"NOTE3"
,"NOTE4"
,"URGENCE"
,"SECURITE"
,"PRIORITAIRE"
) AS SELECT HISTO_NOTE_BSN.DSC_BSN__NUM_BSN AS DSC_BSN__NUM_BSN
,DSC_BSN.LIAISON AS LIAISON
,DSC_BSN.SENS AS SENS
,DSC_BSN.ABS_DEB AS ABS_DEB
,DSC_BSN.CD_FAM_BSN__FAMILLE AS CD_FAM_BSN__FAMILLE
,DSC_BSN.CD_TYPE_BSN__TYPE AS CD_TYPE_BSN__TYPE
,HISTO_NOTE_BSN.DATE_NOTE AS DATE_NOTE
,HISTO_NOTE_BSN.CD_ORIGIN_BSN__ORIGINE AS CD_ORIGIN_BSN__ORIGINE
,HISTO_NOTE_BSN.NOTE1 AS NOTE1
,HISTO_NOTE_BSN.NOTE2 AS NOTE2
,HISTO_NOTE_BSN.NOTE3 AS NOTE3
,HISTO_NOTE_BSN.NOTE4 AS NOTE4
,HISTO_NOTE_BSN.URGENCE AS URGENCE
,HISTO_NOTE_BSN.SECURITE AS SECURITE
,HISTO_NOTE_BSN.PRIORITAIRE AS PRIORITAIRE
 FROM HISTO_NOTE_BSN,DSC_BSN WHERE HISTO_NOTE_BSN.DSC_BSN__NUM_BSN=DSC_BSN.NUM_BSN;
-- Vue V_ELT_INSP_BSN
CREATE OR REPLACE FORCE VIEW "BSN"."V_ELT_INSP_BSN" (
"DSC_BSN__NUM_BSN"
,"CAMP_BSN__ID_CAMP"
,"INDICE"
,"OBS"
,"LIBG"
,"LIBP"
,"LIBS"
,"LIBE"
,"ETAT"
,"NOM_VALID"
,"DATE_VALID"
) AS 
SELECT
ELT_INSP_BSN.DSC_BSN__NUM_BSN AS DSC_BSN__NUM_BSN
,ELT_INSP_BSN.CAMP_BSN__ID_CAMP AS CAMP_BSN__ID_CAMP
,ELT_INSP_BSN.INDICE AS INDICE
,ELT_INSP_BSN.OBS AS OBS
,GRP_BSN.LIBG AS LIBG
,PRT_BSN.LIBP AS LIBP
,SPRT_BSN.LIBS AS LIBS
,ELT_BSN.LIBE AS LIBE
,INSP_BSN.ETAT AS ETAT
,INSP_BSN.NOM_VALID AS NOM_VALID
,INSP_BSN.DATE_VALID AS DATE_VALID
 FROM ELT_INSP_BSN,INSP_BSN,GRP_BSN,PRT_BSN,SPRT_BSN,ELT_BSN 
 WHERE ELT_INSP_BSN.DSC_BSN__NUM_BSN=INSP_BSN.DSC_BSN__NUM_BSN 
 AND ELT_INSP_BSN.CAMP_BSN__ID_CAMP=INSP_BSN.CAMP_BSN__ID_CAMP 
 AND ELT_INSP_BSN.GRP_BSN__ID_GRP=ELT_BSN.GRP_BSN__ID_GRP 
 AND ELT_INSP_BSN.PRT_BSN__ID_PRT=ELT_BSN.PRT_BSN__ID_PRT 
 AND ELT_INSP_BSN.SPRT_BSN__ID_SPRT=ELT_BSN.SPRT_BSN__ID_SPRT 
 AND ELT_INSP_BSN.ELT_BSN__ID_ELEM=ELT_BSN.ID_ELEM  
 AND ELT_INSP_BSN.GRP_BSN__ID_GRP=SPRT_BSN.GRP_BSN__ID_GRP 
 AND ELT_INSP_BSN.PRT_BSN__ID_PRT=SPRT_BSN.PRT_BSN__ID_PRT 
 AND ELT_INSP_BSN.SPRT_BSN__ID_SPRT=SPRT_BSN.ID_SPRT   
 AND ELT_INSP_BSN.GRP_BSN__ID_GRP=PRT_BSN.GRP_BSN__ID_GRP 
 AND ELT_INSP_BSN.PRT_BSN__ID_PRT=PRT_BSN.ID_PRT 
 AND ELT_INSP_BSN.GRP_BSN__ID_GRP=GRP_BSN.ID_GRP;
